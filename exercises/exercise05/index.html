<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Verifying a model with measurements #  The goal of this exercise is to verify our model for the number of loads and stores in a stream benchmark using performance counters, accessed via likwid-perfctr.
Background #  In code/exercise05/stream.c, you can find a C implementation of the STREAM TRIAD benchmark. The code provides a scalar, an SSE, and AVX implementations of the loop
double *a, *b, *c; ... for (i = 0; i &amp;lt; N; i++) { c[i] = c[i] + a[i] * b[i]; } Once compiled, the program can be called as ."><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="Verifying a model with measurements"><meta property="og:description" content="Verifying a model with measurements #  The goal of this exercise is to verify our model for the number of loads and stores in a stream benchmark using performance counters, accessed via likwid-perfctr.
Background #  In code/exercise05/stream.c, you can find a C implementation of the STREAM TRIAD benchmark. The code provides a scalar, an SSE, and AVX implementations of the loop
double *a, *b, *c; ... for (i = 0; i &amp;lt; N; i++) { c[i] = c[i] + a[i] * b[i]; } Once compiled, the program can be called as ."><meta property="og:type" content="article"><meta property="og:url" content="https://scicomp-durham.github.io/COMP52315/exercises/exercise05/"><meta property="article:modified_time" content="2023-02-08T02:19:00+00:00"><title>Verifying a model with measurements | COMP52315 – Performance Engineering, Vectorisation and GPU Programming</title><link rel=icon href=/COMP52315/favicon.svg type=image/x-icon><link rel=stylesheet href=/COMP52315/book.min.0cb0b7d6a1ed5d0e95321cc15edca4d6e9cc406149d1f4a3f25fd532f6a3bb38.css integrity="sha256-DLC31qHtXQ6VMhzBXtyk1unMQGFJ0fSj8l/VMvajuzg="></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav><div class=book-brand><img class=book-center src=/COMP52315/logo.svg alt=Logo><h2><a href=/COMP52315>COMP52315 – Performance Engineering, Vectorisation and GPU Programming</a></h2></div><ul><li><span>Course resources</span><ul><li><a href=/COMP52315/setup/contact/>Contact details</a></li><li><a href=/COMP52315/setup/hamilton/>Hamilton accounts</a></li><li><a href=/COMP52315/setup/configuration/>ssh configuration</a></li><li><a href=/COMP52315/setup/unix/>Unix resources</a></li></ul></li><li><a href=/COMP52315/journal/>Journal</a></li><li><a href=/COMP52315/exercises/>Exercises</a><ul></ul></li><li><a href=/COMP52315/notes/>Notes</a><ul></ul></li><li><a href=/COMP52315/resources/>Further resources</a></li><li><a href=/COMP52315/acknowledgements/>Acknowledgements</a></li><li><a href=/COMP52315/past-editions/>Past editions</a><ul><li><a href=/COMP52315/past-editions/2020-21/>Edition 2020/2021</a><ul></ul></li><li><a href=/COMP52315/past-editions/2021-22/>Edition 2021/2022</a><ul></ul></li></ul></li></ul></nav><script>(function(){var menu=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(event){localStorage.setItem("menu.scrollTop",menu.scrollTop);});menu.scrollTop=localStorage.getItem("menu.scrollTop");})();</script></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/COMP52315/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Verifying a model with measurements</strong>
<label for=toc-control><img src=/COMP52315/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#verifying-a-model-with-measurements>Verifying a model with measurements</a><ul><li><a href=#background>Background</a></li><li><a href=#compiling-with-likwid-annotations-enabled>Compiling with likwid annotations enabled</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=verifying-a-model-with-measurements>Verifying a model with measurements
<a class=anchor href=#verifying-a-model-with-measurements>#</a></h1><p>The goal of this exercise is to verify our model for the number of
loads and stores in a stream benchmark using performance counters,
accessed via
<a href=https://github.com/RRZE-HPC/likwid/wiki/likwid-perfctr><code>likwid-perfctr</code></a>.</p><h2 id=background>Background
<a class=anchor href=#background>#</a></h2><p>In <code>code/exercise05/stream.c</code>, you can find <a href=https://scicomp-durham.github.io/COMP52315/code/exercise05/stream.c>a C implementation</a> of the <a href=https://www.cs.virginia.edu/stream/>STREAM
TRIAD</a> benchmark. The code provides
a scalar, an SSE, and AVX implementations of the loop</p><div class=highlight><pre style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>double</span> <span style=color:#f92672>*</span><span style=color:#111>a</span><span style=color:#111>,</span> <span style=color:#f92672>*</span><span style=color:#111>b</span><span style=color:#111>,</span> <span style=color:#f92672>*</span><span style=color:#111>c</span><span style=color:#111>;</span>
<span style=color:#111>...</span>
<span style=color:#00a8c8>for</span> <span style=color:#111>(</span><span style=color:#111>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span><span style=color:#111>;</span> <span style=color:#111>i</span> <span style=color:#f92672>&amp;</span><span style=color:#111>lt</span><span style=color:#111>;</span> <span style=color:#111>N</span><span style=color:#111>;</span> <span style=color:#111>i</span><span style=color:#f92672>++</span><span style=color:#111>)</span> <span style=color:#111>{</span>
  <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>=</span> <span style=color:#111>c</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>+</span> <span style=color:#111>a</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>]</span> <span style=color:#f92672>*</span> <span style=color:#111>b</span><span style=color:#111>[</span><span style=color:#111>i</span><span style=color:#111>];</span>
<span style=color:#111>}</span>
</code></pre></div><p>Once compiled, the program can be called as <code>./stream &lt;N> &lt;LOOP_TYPE></code>,
where <code>&lt;N></code> is the number of elements in the three arrays and
<code>&lt;LOOP_TYPE></code> is one of <code>sca</code>, <code>sse</code>, <code>avx</code>, <code>fma</code>, <code>align</code>, or
<code>unalign</code>. See <code>./stream -h</code> (or the source code itself) for more
details on this option.</p><p>We will measure the number of loads and stores for this loop using
<code>likwid-perfctr</code>. In order to do so, we need to compile the code
appropriately.</p><h2 id=compiling-with-likwid-annotations-enabled>Compiling with likwid annotations enabled
<a class=anchor href=#compiling-with-likwid-annotations-enabled>#</a></h2><p>The code is annotated with <a href=https://github.com/RRZE-HPC/likwid/wiki/likwid-perfctr#using-the-marker-api>likwid-specific
markers</a>
around the relevant loops. This is to ensure that counters are measured
only for the portions of codes we are interested in profilin We
therefore need to enable these when compiling. As before we load the
likwid module with <code>module load likwid/5.2.0</code>.</p><p>We can safely compile this code with GCC, load the GCC module with
<code>module load gcc/12.2</code> and run:</p><pre><code>gcc -std=c99 -mfma -O1 -DLIKWID_PERFMON -fno-inline -march=native -o stream stream.c -llikwid
</code></pre><p>The flag <code>-DLIKWID_PERFMON</code> adds a new symbol in the
preprocessor which will turn on the likwid markers. We then also need
to link against the likwid runtime library with <code>-llikwid</code>.
To ensure that this library is available when you run the code, you
should load the likwid module on the compute node (or run <code>module load likwid/5.2.0</code> in your batch submission script).</p><p>For this exercise, <code>likwid-perfctr</code> does not give us an appropriate
predefined group. Instead, we must use a low-level counter directly. The
relevant counters are <code>LS_DISPATCH_LOADS</code> for loads and
<code>LS_DISPATCH_STORES</code> for stores. We must specify a <a href=https://github.com/RRZE-HPC/likwid/wiki/likwid-perfctr#using-custom-event-sets><em>group
string</em></a>,
of the form <code>&lt;counter>:&lt;register></code>, where <code>&lt;counter></code> is the performance
counter we want to use (for example <code>LS_DISPATCH_LOADS</code>) and
<code>&lt;register></code> is the register in which we want to save it. For memory
operations we can use the registers <code>PMC0</code> and <code>PMC1</code> (possibly others,
but these will suffice).</p><p>A complete command line to measure the number of loads is</p><pre><code>likwid-perfctr -m -g &quot;LS_DISPATCH_LOADS:PMC0&quot; -C 0 ./stream 1000000 sca
</code></pre><p>This tell <code>liwid-perfctr</code> to enable the marker API (with <code>-m</code>), to count
the <code>LS_DISPATCH_LOADS</code> event in <code>PMC0</code>, and to pin the
executable to core zero (with <code>-C 0</code>). This final part is necessary so
that the operating system does not move the executable from one core to
another during execution, which would break our measurements. The
command should produce an output like the following:</p><pre><code>--------------------------------------------------------------------------------
CPU name:       AMD EPYC 7702 64-Core Processor
CPU type:       AMD K17 (Zen2) architecture
CPU clock:      2.00 GHz
--------------------------------------------------------------------------------
WARN: Skipping region SSE-0 for evaluation.
WARN: Skipping region AVX-0 for evaluation.
WARN: Skipping region FMA-0 for evaluation.
WARN: Skipping region UNALIGNED-0 for evaluation.
WARN: Skipping region ALIGNED-0 for evaluation.
WARN: Regions are skipped because:
      - The region was only registered
      - The region was started but never stopped
      - The region was never started but stopped
sca loop, sum 3.33328e+17
--------------------------------------------------------------------------------
Region Scalar, Group 1: Custom
+-------------------+------------+
|    Region Info    | HWThread 0 |
+-------------------+------------+
| RDTSC Runtime [s] |   0.001400 |
|     call count    |          1 |
+-------------------+------------+

+---------------------+---------+--------------+
|        Event        | Counter |  HWThread 0  |
+---------------------+---------+--------------+
| Runtime (RDTSC) [s] |   TSC   | 1.400006e-03 |
|  LS_DISPATCH_LOADS  |   PMC0  |      3005392 |
+---------------------+---------+--------------+
</code></pre><p>This measurement at least, aligns with what we expected, since we see
about 3000000 loads.</p><blockquote class=question><h3>Question</h3><span><ol><li>How does the number of loads change if you use the SSE, AVX, or FMA
versions of the code?</li><li>How many stores do you measure?</li></ol></span></blockquote></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/scicomp-durham/COMP52315/commit/5e994206d6719c797436471e6da757e835e3610b title="Last modified by Massimiliano Fasi | February 8, 2023" target=_blank rel=noopener><img src=/COMP52315/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 8, 2023</span></a></div><div><a class="flex align-center" href=https://github.com/scicomp-durham/COMP52315/edit/main/site/content//exercises/exercise05.md target=_blank rel=noopener><img src=/COMP52315/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><div class="flex flex-wrap align-right"><p>© 2020&ndash;2023 <a href=mailto:lawrence@wence.uk>Lawrence Mitchell</a>, <a href=mailto:massimiliano.fasi@durham.ac.uk>Massimiliano Fasi</a>, and <a href=https://www.dur.ac.uk/>Durham University</a>.</p><p><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=/COMP52315/cc-by-sa.svg></a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative
Commons Attribution-ShareAlike 4.0 International License</a>.</p></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#verifying-a-model-with-measurements>Verifying a model with measurements</a><ul><li><a href=#background>Background</a></li><li><a href=#compiling-with-likwid-annotations-enabled>Compiling with likwid annotations enabled</a></li></ul></li></ul></nav></aside></main></body></html>